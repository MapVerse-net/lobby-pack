# git-cliff ~ configuration file
# https://git-cliff.org/docs/configuration

[changelog]
# A Tera template to be rendered as the changelog's footer.
# See https://keats.github.io/tera/docs/#introduction
header = """
# Changelog\n
All notable changes to this project will be documented in this file. See [conventional commits](https://www.conventionalcommits.org/) for commit guidelines.\n
"""
# A Tera template to be rendered for each release in the changelog.
# See https://keats.github.io/tera/docs/#introduction
body = """
{% if version %}
    {% if previous.version %}
## [{{ version | trim_start_matches(pat="v") }}]($REPO/compare/{{ previous.version }}..{{ version }}) - {{ timestamp | date(format="%Y-%m-%d") }}
    {% else %}
## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
    {% endif %}
{% else %}
## [Unreleased]
{% endif %}

{% for group, commits in commits | group_by(attribute="group") %}
### {{ group | striptags | trim | upper_first }}

{% set scoped = commits
    | filter(attribute="scope")
    | sort(attribute="scope")
    | sort(attribute="message")
%}

{% for commit in scoped %}
- **({{ commit.scope }})**{% if commit.breaking %} **[breaking]**{% endif %}
  {{ commit.message }}
  ([{{ commit.id | truncate(length=7, end="") }}]($REPO/commit/{{ commit.id }}))
  — {{ commit.author.name }}
{% endfor %}

{% for commit in commits %}
{% if not commit.scope %}
- {% if commit.breaking %}**[breaking]** {% endif %}
  {{ commit.message }}
  ([{{ commit.id | truncate(length=7, end="") }}]($REPO/commit/{{ commit.id }}))
  — {{ commit.author.name }}
{% endif %}
{% endfor %}

{% endfor %}

{% set authors = commits | map(attribute="author.name") %}

{% set coauthors = [] %}
{% for commit in commits %}
    {% if commit.body %}
        {% for match in commit.body | regex_find_all(pat="Co-authored-by:\\s*(.+?)\\s*<") %}
            {% set_global coauthors = coauthors | concat(with=[match]) %}
        {% endfor %}
    {% endif %}
{% endfor %}

{% set contributors = authors | concat(with=coauthors) | unique | sort %}

### Contributors
{% for c in contributors %}
- {{ c }}
{% endfor %}
"""

footer = """
<!-- generated by git-cliff -->
"""
trim = true
postprocessors = [
  { pattern = '\$REPO', replace = "%%%repo_url%%%" }
]

[git]
# Parse commits according to the conventional commits specification.
# See https://www.conventionalcommits.org
conventional_commits = true
# Exclude commits that do not match the conventional commits specification.
filter_unconventional = false
split_commits = false

commit_preprocessors = [
  { pattern = '\((\w+\s)?#([0-9]+)\)', replace = "([#${2}](%%%repo_url%%%/issues/${2}))" }
]

commit_parsers = [
  { message = "^feat", group = "Features" },
  { message = "^fix", group = "Fixes" },
  { message = "^doc", group = "Documentation" },
  { message = "^perf", group = "Performance" },
  { message = "^refactor", group = "Refactoring" },
  { message = "^style", group = "Code Style" },
  { message = "^revert", group = "Revert" },
  { message = "^test", group = "Tests" },
  { message = "^chore", group = "Chores" },
  { body = ".*security", group = "Security" },
  { message = ".*\\((ci|cd|dx)(/.*)?\\).*", group = "Development/Tooling" },

  # Fallback
  { message = ".*", group = "Other" },
]

filter_commits = false
# Order releases topologically instead of chronologically.
topo_order = false
# Order of commits in each group/release within the changelog.
# Allowed values: newest, oldest
sort_commits = "oldest"
